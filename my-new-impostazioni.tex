
% *****************************************************************************
% 	General commands
% *****************************************************************************

% [...] ;-) NO replaced by \textelp{} and other feature of cvsquotes package
%\newcommand{\omissis}{[\dots\negthinspace]}

% Indica a LaTeX la cartella dove sono riposti i file delle immagini
\graphicspath{{./},{./Asymptote/}, {./Images/}, {./Metapost/}}

% Un ambiente ad hoc per gli approfondimenti (definirlo si, ma magari in altro
% modo)
\newenvironment{approfondimento}%
{\begin{quoting}}
  {\end{quoting}}

% i.e. and e.g.
% here with thin space (most german convetion), see typography discussion in 
% http://tex.stackexchange.com/questions/25831/canonical-way-to-typeset-spacing-in-abbreviations
\providecommand{\ie}{i.\,e.}
\providecommand{\Ie}{I.\,e.}
\providecommand{\eg}{e.\,g.}
\providecommand{\Eg}{E.\,g.} 

% th
\newcommand{\ordth}{\textsuperscript{th}}

% Cpp 
\def\cpp{\mbox{C++}}

% *****************************************************************************
% 	Signature
% *****************************************************************************
% tmark 
\newcommand{\tmark}[1]{%
  {{\unskip\nobreak\hfil\penalty50
  \hskip2em\vadjust{}\nobreak\hfil[#1]%
  \parfillskip=0pt \finalhyphendemerits=0 \par
  \penalty 10000 \parskip=0pt\noindent}}\ignorespaces}

% Signature environment
\makeatletter
\newcommand*{\stopbreaks}{%
  \interlinepenalty\@M
  \def\par{\@@par\nobreak}%
  \let\\\@nobreakcr
  \let\vspace\@nobreakvspace}
\makeatother

\def\signature{%
  \par\raggedleft\nopagebreak\vspace{.8em}%
%  \stopbreaks%
}
\def\endsignature{\par}%\endgroup\par}

\newcommand{\mySignature}[2]{%
  \par\noindent\nopagebreak\vspace{.8em}%
  \begingroup
  \stopbreaks%
  \begin{minipage}[b]{0.49\textwidth}%
  \raggedright
  #1
  \end{minipage}
  \hfill
  \begin{minipage}[b]{0.49\textwidth}
  \raggedleft
  #2
  \end{minipage}
  \endgroup
  \par
}

% *****************************************************************************
%       Finer typography	
% *****************************************************************************
%\usepackage[draft,%
%hyphenation,lastparline,nosingleletter,homeoarchy,rivers]{impnattypo}
\usepackage[hyphenation]{impnattypo}
\usepackage[punct-after=false]{fnpct} 
\AdaptNoteOptNoMult\autocite
\setfnpct{add-punct-marks=:}
\setfnpct{add-punct-marks=;}
\usepackage[biblatex=true]{embrac}

\AdaptNoteOpt\footcite\multfootcite
\AdaptNoteOpt\autocite\multautocite

% *****************************************************************************
% 	Additional hyperref stuff (to be improved)
% *****************************************************************************
\hypersetup{%
    colorlinks=true, linktocpage=true, pdfstartpage=1, pdfstartview=FitV,%
    breaklinks=true, pdfpagemode=UseNone, pageanchor=true, pdfpagemode=UseOutlines,%
    plainpages=false, bookmarksnumbered, bookmarksopen=true, bookmarksopenlevel=1,%
    hypertexnames=true, pdfhighlight=/O,%
    urlcolor=webbrown, linkcolor=RoyalBlue, citecolor=RoyalBlue, pagecolor=RoyalBlue,%
   hyperfootnotes=true,%
% uncomment the following line if you want to have black links (e.g., for printing)
% urlcolor=Black, linkcolor=Black, citecolor=Black, pagecolor=Black,%
    pdftitle={\myTitle},%
    pdfauthor={\textcopyright\ \myName},%
    pdfsubject={},%
    pdfkeywords={},%
    pdfcreator={pdfLaTeX},%
}


\hypersetup{citecolor=webblue}

\newcommand{\mail}[1]{\href{mailto:#1}{\texttt{#1}}}

% *****************************************************************************
% 	Mathematica Packages
% *****************************************************************************

% Save accent for wick.sty (eulervm already downloaded)
\let\oldhat\hat
\let\oldbar\bar

% A.M.S. standard packages.
\usepackage{amssymb}

% Numerical sets (amssymb package required).
%\newcommand{\numberset}{\mathbb} 
%\newcommand{\N}{\numberset{N}} 
%\newcommand{\Z}{\numberset{Z}} 
%\newcommand{\Q}{\numberset{Q}} 
%\newcommand{\R}{\numberset{R}} 
%\newcommand{\C}{\numberset{C}} 

% Dirac notation (braket package required).
\usepackage{braket} 
\newcommand{\modul}[1]{\mathinner{\vert#1\vert}} 
\newcommand{\Modul}[1]{\left\vert#1\right\vert} 
%\newcommand{\norm}[1]{\mathinner{\Vert#1\Vert}}
%\newcommand{\Norm}[1]{\left\Vert#1\right\Vert}
%\newcommand{\conj}[1]{#1^{*}} 
\newcommand{\adj}[1]{#1^{\dagger}}

% Un ambiente per i sistemi.
\newenvironment{sistema}%
  {\left\lbrace\begin{array}{@{}l@{}}}%
  {\end{array}\right.}
 
% Cool package. (Non male per funzioni speciali e spazitura integrali, ma poco
% customizzabile per integrali multiple)
\usepackage{cool}
\makeatletter
  \Style{ArcTrig=arc}
  \Style{DSymb={{\operator@font d}}}
  \Style{DDisplayFunc=inset,DShorten=true}
  \Style{IntegrateDifferentialDSymb={{\operator@font d}}}
  \makeatother

% Costumizing  
\newcommand{\nto}[3]{#1 = #2, \ldots, #3}
\newcommand{\fullfunction}[3]{#1\colon#2\to#3}

% Intervals 
\usepackage{interval}
\newcommand{\commutator}[2]{\interval[scaled]{#1}{#2}}
\newcommand{\anticommutator}[2]{\interval[left closed fence={\{}, right closed fence={\}}, scaled]{#1}{#2}}

% skmath (for differential forms, numeric sets, improvements of functions)
%\usepackage[commonsets=true,notation=iso]{skmath}
\usepackage[commonsets=true]{skmath}
\usepackage{skmath_amends}
\newcommand{\pauli}{\sigma}
% Groups
\DeclareDocumentCommand\SU{m}{%
   \ensuremath{\operatorname{SU}(#1)}}
\DeclareDocumentCommand\SO{m}{%
   \ensuremath{\operatorname{SO}(#1)}}

% path integrals with cool, to allow for better spacing
\makeatletter
\newcommand{\pathint}[2]
{
   %\begingroup
   \let\oldd\COOL@notation@IntegrateDifferentialDSymb
   \renewcommand{\COOL@notation@IntegrateDifferentialDSymb}{\mathcal{D}}
   \Int{#1}{#2}
   \let\COOL@notation@IntegrateDifferentialDSymb\oldd
%\endgroup
}
\makeatother

\makeatletter
\newcommand{\MultipleIntegrate}[4]{%
   \int_{#3}^{#4}  #1 
   \@for\df:=#2\do{%
      \,
      \COOL@notation@IntegrateDifferentialDSymb{}\df%
   }
}
\makeatother

\makeatletter
\newcommand{\oInt}[2]{%
\listval{#2}{0}%
\setcounter{COOL@listlen}{\value{COOL@listpointer}}%
\ifthenelse{ \value{COOL@listlen} = 1 }%
{%
\ifthenelse{\equal{\COOL@notation@IntegrateDisplayFunc}{outset}}%
{%
\oint \! \COOL@notation@IntegrateDifferentialDSymb{}#2 \, #1%
}%
{ \ifthenelse{\equal{\COOL@notation@IntegrateDisplayFunc}{inset}}%
{%
\oint #1 \, \COOL@notation@IntegrateDifferentialDSymb{}#2%
}%
{%
\PackageError{cool}{Invalid Option Sent}%
{`DisplayFunc' can only be `inset' or `outset'}%
}}%
}%
{ \ifthenelse{ \value{COOL@listlen} = 2 }%
{%
\ifthenelse{\equal{\COOL@notation@IntegrateDisplayFunc}{outset}}%
{%
\oint_{\listval{#2}{2}} \!
\COOL@notation@IntegrateDifferentialDSymb{}{\listval{#2}{1}} \, #1%
}%
{ \ifthenelse{\equal{\COOL@notation@IntegrateDisplayFunc}{inset}}%
{%
\oint_{\listval{#2}{2}} #1 \,
\COOL@notation@IntegrateDifferentialDSymb{}{\listval{#2}{1}}%
}%
{%
\PackageError{cool}{Invalid Option Sent}%
{`DisplayFunc' can only be `inset' or `outset'}%
}}%
}%
{ \ifthenelse{ \value{COOL@listlen} = 3 }%
{%
\ifthenelse{\equal{\COOL@notation@IntegrateDisplayFunc}{outset}}%
{%
\oint_{\listval{#2}{2}}^{\listval{#2}{3}} \!
\COOL@notation@IntegrateDifferentialDSymb{}{\listval{#2}{1}} \, #1%
}%
{ \ifthenelse{\equal{\COOL@notation@IntegrateDisplayFunc}{inset}}%
{%
\oint_{\listval{#2}{2}}^{\listval{#2}{3}} #1 \,
\COOL@notation@IntegrateDifferentialDSymb{}{\listval{#2}{1}}%
}%
{%
\PackageError{cool}{Invalid Option Sent}%
{`DisplayFunc' can only be `inset' or `outset'}%
}}%
}%
{%
\PackageError{cool}{`Integrate' has invalid parameter list}%
   {this happens when the second argument has more than two commas}%
}}}%
}%
\makeatother


% *****************************************************************************
% 	Cleveref support for breqn
% *****************************************************************************
\usepackage{cleveref}
\crefname{chapter}{\S}{\S}
\Crefname{chapter}{\S}{\S}


% *****************************************************************************
% 	Theorem and Definition Environments.
% *****************************************************************************

\usepackage{amsthm}                       % A.M.S. package for theorems.

\makeatletter
  \newtheoremstyle{classicdef}%           % Stile tipografico dei teoremi
  {11pt}%                                 % Spazio che precede l'enunciato
  {11pt}%                                 % Spazio che segue l'enunciato
  {}%                                     % Stile del font dell'enunciato
  {}%                                     % Rientro (se vuoto, nessun rientro;
  %                                       % \parindent = rientro dei capoversi)
  {\scshape}%                             % Font dell'intestazione
  {:}%                                    % Punteggiatura dopo l'intestazione
  {.5em}%                                 % Spazio che segue l'intestazione:
  %                                       % " " = normale spazio inter-parola;
  %                                       % \newline = a capo
  {}%                                     % Specifica intestazione enunciato
\makeatother

\theoremstyle{classicdef}
\newtheorem{theorem}{Theorem}[chapter]
\newtheorem{lemma}{Lemma}[chapter]
\newtheorem{definition}{Definition}[chapter]
\newtheorem{exercise}{Exercise}[chapter]
\newtheorem*{homework}{Homework}
\theoremstyle{remark}
\newtheorem*{remark}{Remark}
\newtheorem*{hint}{Hint}
\renewcommand{\qedsymbol}{\rule{.5em}{.5em}}

% *****************************************************************************
% 	Exercise environment 
% *****************************************************************************

\usepackage{tcolorbox}
% *****************************************************************************
% 	Vectors 
% *****************************************************************************
\MakeRobust\vec


% *****************************************************************************
% 	Biblatex 
% *****************************************************************************

\renewcommand{\nameyeardelim}{, }

\defbibheading{bibliography}{%
\cleardoublepage
\manualmark
\phantomsection
%\ifminitoc
%\mtcaddchapter[\numberline{}\tocEntry{\bibname}]
%\else
\addtocontents{toc}{\protect\vspace{\beforebibskip}}
\addcontentsline{toc}{chapter}{\numberline{}\tocEntry{\bibname}}
%\fi
\myChapter*{\bibname\markboth{\spacedlowsmallcaps{\bibname}}
{\spacedlowsmallcaps{\bibname}}}}     


\defbibheading{subbibliography}{%
   \section*{References for \cref{refsection:\therefsection}}}


% *****************************************************************************
% 	Caption
% *****************************************************************************
\usepackage{caption}                      % Fancy captions and more.
\DeclareCaptionFont{captioncolor}{\color{hilite}}
\captionsetup{format=plain,labelsep=period,font=small, labelfont={sc,
      captioncolor}}
\captionsetup[table]{skip=\medskipamount} 


% *****************************************************************************
% 	Makeidx, Multicol
% *****************************************************************************
\usepackage{varindex}
\usepackage{toolbox}
\let\orgtheindex\theindex
\let\orgendtheindex\endtheindex
\def\theindex{%
	\def\twocolumn{\begin{multicols}{2}}%
	\def\onecolumn{}%
	\clearpage
	\orgtheindex
}
\def\endtheindex{%
	\end{multicols}%
	\orgendtheindex
}

\makeindex

% *****************************************************************************
% 	Tensors 
% *****************************************************************************
\usepackage{tensind}
\tensordelimiter{@}

% *****************************************************************************
% 	Lettrine 
% *****************************************************************************
\usepackage{lettrine}
\usepackage{etoolbox}
\makeatletter
\patchcmd{\@lettrine}{$}{\relax}{}{}
\patchcmd{\@lettrine}{$}{}{}{}
\makeatother


% *****************************************************************************
% 	Breqn
% *****************************************************************************
\usepackage{mathtools}                    % Add support for cramped,
					  % mathlap,etc.
\usepackage[euler]{flexisym}              % Add support to Euler font
\usepackage{breqn}                        % Breqn
\catcode`\_=8 % for safety
%\catcode`_=12
%\catcode`^=12
\makeatletter
   \def\eqnumsize{\normalfont \Tf@font}   % Add support to Minion Pro
\makeatother

\setkeys{breqn}{labelprefix={eq:}}

\newcommand\coloneqq{\mathrel{:\mkern-1.2mu=}}

% *****************************************************************************
% 	Feyn support for breqn
% *****************************************************************************
\usepackage[noglobalbang]{feyn}
\makeatletter
\def\vertexlabel#1#2{
   \setbox0=\hbox to 0pt{\hss$\scriptstyle #2$\hss}
   \begingroup
   \lccode`|=`^
   \lccode`!=`_
  \ifcat #1|
 \endgroup
    \vbox to 0pt{\vss\box0\nointerlineskip\kern2\feyn@maxis}
  \else\ifcat #1!
 \endgroup
    \vbox to 0pt{\kern\feyn@maxis\nointerlineskip\box0\vss}
  \else
 \endgroup
    \PackageError{feyn}
      {Bad arguments for \string\vertexlabel}
      {Usage: \string\vertexlabel^{text} or \string\vertexlabel_{text}}
 \fi\fi
  }
  \makeatother



% *****************************************************************************
% 	Cleveref support for breqn
% *****************************************************************************

\makeatletter
\renewcommand\set@label[2]{\protected@edef\@currentlabel{#2}
\cref@constructprefix{equation}{\cref@result}%
\protected@xdef\cref@currentlabel{%
[equation][\arabic{equation}][\cref@result]\eq@number}
  %%% Work in progress... Support for hyperref 
  \hyper@makecurrent{equation}
  \Hy@raisedlink{\hyper@anchorstart{\@currentHref}}
  \Hy@raisedlink{\hyper@anchorend}
}
\makeatother

%\input{kerning.tex}

% *****************************************************************************
%	 Margins
% *****************************************************************************
% Suggestions from ClassicThesis
% Palatino 	10pt: 288--312pt | 609--657pt
% Palatino 	11pt: 312--336pt | 657--705pt
% Palatino 	12pt: 360--384pt | 768pt

\areaset[current]{336pt}{750pt}
\setlength{\marginparwidth}{7em}
\setlength{\marginparsep}{2em}%

% *****************************************************************************
% 	 Sections and optional sections
% *****************************************************************************

\colorlet{seccolor}{black}

\definecolor{hilite}{rgb}{0.2,0.4,0.7}


\newcommand{\secmark}{}
\newcommand{\marktotoc}[1]{\renewcommand{\secmark}{#1}}
\newenvironment{advanced}{
   \renewcommand{\secmark}{*}%
   \addtocontents{toc}{\protect\marktotoc{*}}
}
{\addtocontents{toc}{\protect\marktotoc{}}}

% \colorlet{seccolor}{hilite}
% sections \FloatBarrier
    \titleformat{\section}
    {\relax}{\color{seccolor}\textsc{% moved below
	  \makebox[1.5em][l]{\llap{\secmark}%added for * sections
	     \MakeTextLowercase{\thesection}}}}{1em}{\color{seccolor}\spacedlowsmallcaps}
    % subsections
    \titleformat{\subsection}
    {\relax}{\color{seccolor}\textsc{\MakeTextLowercase{\thesubsection}}}{1em}{\color{seccolor}\normalsize\itshape}
    % subsubsections
    \titleformat{\subsubsection}
    {\relax}{\color{seccolor}\textsc{\MakeTextLowercase{\thesubsubsection}}}{1em}{\color{seccolor}\normalsize\itshape}        
    % descriptionlabels
    \renewcommand{\descriptionlabel}[1]{\color{seccolor}\hspace*{\labelsep}\spacedlowsmallcaps{#1}}   % spacedlowsmallcaps textit textsc                  


    \usepackage{titletoc}
    \titlecontents{section}[3.7em]{}{\contentslabel[\llap{\secmark}\thecontentslabel]{2.3em}}{\hspace*{-2.3em}}{\contentspage}



% *****************************************************************************
% 	Wick contraction 
% *****************************************************************************
\usepackage{wick}% Very powerful, but some troubles with AMSmath accents
\usepackage{simplewick}% Alternative way to typeset Wick contraction..

% Naive way to save accents inside wick environment (the changes do not effect
% the behavior of accents outside wick macro)

\def\newhat#1{{\oldhat{#1}}}
\def\newbar#1{{\oldbar{#1}}}

%\def\WKsep{.5}    

\let\oldwick\wick
\renewcommand{\wick}[3][o]
{\begingroup
\let\hat\newhat
\let\bar\newbar
\oldwick[#1]{#2}{#3}
\endgroup
}

\let\oldWwick\Wwick
\renewcommand{\Wwick}[4]
{\begingroup
\let\hat\newhat
\let\bar\newbar
\oldWwick{#1}{#2}{#3}{#4}
\endgroup
}
% *****************************************************************************
% 	Quaternions
% *****************************************************************************
%\newcommand{\qe}{\vec{e}}
%\newcommand{\qi}{\vec{i}}
%\newcommand{\qj}{\vec{j}}
%\newcommand{\qk}{\vec{k}}

% *****************************************************************************
%      Conj
% *****************************************************************************
\usepackage{linop}

% *****************************************************************************
% 	Additional setup and packages
% *****************************************************************************

\hypersetup{citecolor=webbrown}
\hypersetup{pdfstartpage=1}

\usepackage{nicefrac}
\usepackage{calligra}
%\usepackage{sidenotes}


\usepackage{paralist}
\usepackage{cancel}
\usepackage{slashed}

% *****************************************************************************
% 	Footnotes
% *****************************************************************************

\usepackage[perpage, symbol*, stable, multiple]{footmisc}	
\setlength{\footnotemargin}{.6em}%
%\usepackage{footnpag}
%\makeatletter
%      \renewcommand*\thefootnote{\@fnsymbol\c@footnote}%
%      \makeatother
\input{my-footnote-stuff}
\usepackage{footnotebackref}


% *****************************************************************************
% 	Asymptote
% *****************************************************************************
\usepackage{asymptote}       % Asymptote Graphical Vector Language.

%\begin{asydef}
%defaultpen(fontsize(10pt));
%texpreamble("\usepackage[opticals,onlytext]{MinionPro}");
%texpreamble("\usepackage[small]{eulervm}");
%texpreamble("\usepackage{nicefrac}");
%texpreamble("\usepackage{cool}");
%\end{asydef}

\newcommand*\openquote{\makebox(25,-12){\color{lightgray}\scalebox{5}{``}}}
\newcommand*\closequote{\makebox(25,-22){\color{lightgray}\scalebox{5}{''}}}

\Crefname{problem}{L'esercizio}{Gli esercizi}%
\crefname{problem}{l'esercizio}{gli esercizi}%


% Rewrite the appendix macro to avoid side effects on footnotes spacing

%\makeatletter
%\renewcommand*\appendix{\par%
%  \setcounter{chapter}{0}%
%  \setcounter{section}{0}%
%  \gdef\@chapapp{\appendixname}%
%  \gdef\thechapter{\@Alph\c@chapter}%
%  %\csname appendixmore\endcsname
%}
%\makeatother

\newtcolorbox[auto counter,number within=section]{pabox}[2][]{%
   colback=red!5!white,colframe=red!75!black,fonttitle=\bfseries,
   title=Exercise.~\thetcbcounter: #2,#1}

\newenvironment{Exercise}{\begin{exercise}}{\end{exercise}}



%\input{kerning4}
